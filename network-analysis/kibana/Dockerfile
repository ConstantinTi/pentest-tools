FROM docker.elastic.co/kibana/kibana:7.10.1

COPY --chown=kibana:kibana etc/* /usr/share/kibana/config/

USER root
RUN mkdir -p /var/log/kibana/ && \
	touch /var/log/kibana/kibana.log && \
	chown kibana:kibana -R /var/log/kibana/ && \
    chown kibana:kibana -R /var/lib/kibana/ && \
    chown -R kibana:kibana /opt/kibana/optimize && \
    chmod g+s /opt/kibana/optimize

RUN echo 'NODE_OPTIONS="--max-old-space-size=2048"' >> /etc/default/kibana

HEALTHCHECK --retries=50 CMD curl -s -XGET 'http://127.0.0.1:5601/kibana/api/status' | grep -v "Kibana server is not ready yet" || exit 1
USER kibana:kibana
CMD ["/usr/share/kibana/bin/kibana"]
